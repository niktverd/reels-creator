# План реализации расширенного функционала Instagram API

## 1. Подготовка инфраструктуры

### 1.1 Обновление типов данных

#### 1.1.1 Расширение интерфейса MediaItem для поддержки insights

- Добавить поля для метрик вовлеченности (impressions, reach, engagement_rate)
- Добавить поля для метрик видео (video_views, average_watch_time)
- Добавить поля для метрик Stories (exits, replies, link_clicks)

#### 1.1.2 Создание новых интерфейсов

- `InsightsData` - для хранения аналитических данных
- `Comment` - для работы с комментариями
- `CommentReply` - для ответов на комментарии
- `InsightsPeriod` - для временных периодов аналитики
- `MediaInsights` - для детальной аналитики по медиа
- `AccountInsights` - для общей аналитики аккаунта
- `DirectMessage` - для работы с Direct Messages

#### 1.1.3 Обновление существующих интерфейсов

- Расширить `InstagramContent` для включения insights
- Добавить пагинацию для комментариев
- Добавить фильтры для аналитики

### 1.2 Настройка API endpoints

#### 1.2.1 Создание структуры папок

- `/pages/api/instagram/insights/` - для аналитики
- `/pages/api/instagram/comments/` - для комментариев
- `/pages/api/instagram/messages/` - для Direct Messages

#### 1.2.2 Базовые утилиты

- Создать общий модуль для работы с Instagram Business API
- Реализовать обработку ошибок и rate limiting
- Создать логирование для отладки

## 2. Реализация функционала аналитики (instagram_business_manage_insights)

### 2.1 Backend API endpoints

#### 2.1.1 `/api/instagram/insights/media`

- Получение insights для конкретного поста
- Параметры: mediaId, metrics[], period
- Возвращает: метрики вовлеченности, охват, просмотры

#### 2.1.2 `/api/instagram/insights/account`

- Получение общей статистики аккаунта
- Параметры: period, metrics[]
- Возвращает: общие метрики аккаунта за период

#### 2.1.3 `/api/instagram/insights/stories`

- Получение аналитики для Stories
- Параметры: storyIds[], metrics[]
- Возвращает: метрики по каждой Story

#### 2.1.4 `/api/instagram/insights/compare`

- Сравнение метрик между постами
- Параметры: mediaIds[], metrics[]
- Возвращает: сравнительную таблицу метрик

#### 2.1.5 `/api/instagram/insights/export`

- Экспорт отчетов в PDF/CSV
- Параметры: format, period, metrics[]
- Возвращает: ссылку на скачивание файла

### 2.2 Frontend компоненты

#### 2.2.1 Компонент `InsightsDashboard`

##### 2.2.1.1 Основной layout

- Табы для разных типов контента (Posts, Stories, Reels)
- Фильтры по датам
- Кнопки экспорта

##### 2.2.1.2 Карточки метрик

- `MetricCard` - отображение одной метрики
- `MetricTrend` - показ тренда изменения
- `MetricComparison` - сравнение с предыдущим периодом

#### 2.2.2 Компонент `InsightsChart`

##### 2.2.2.1 Типы графиков

- Линейный график для трендов
- Столбчатая диаграмма для сравнения
- Круговая диаграмма для распределения

##### 2.2.2.2 Интерактивность

- Hover эффекты с подробностями
- Zoom функциональность
- Переключение метрик

#### 2.2.3 Компонент `ContentPerformanceTable`

##### 2.2.3.1 Таблица с сортировкой

- Колонки: превью, дата, метрики
- Сортировка по любой метрике
- Пагинация

##### 2.2.3.2 Детальный просмотр

- Модальное окно с подробностями
- График изменения метрик во времени
- Сравнение с средними показателями

#### 2.2.4 Компонент `BestTimeToPost`

##### 2.2.4.1 Анализ активности

- Тепловая карта по дням и часам
- Рекомендации на основе данных
- История успешных публикаций

##### 2.2.4.2 Планировщик

- Календарь с рекомендуемым временем
- Интеграция с расписанием публикаций

### 2.3 Хуки для работы с insights

#### 2.3.1 `useMediaInsights`

- Загрузка insights для медиа
- Кеширование данных
- Обновление в реальном времени

#### 2.3.2 `useAccountInsights`

- Общая статистика аккаунта
- Агрегация данных по периодам
- Расчет трендов

#### 2.3.3 `useInsightsComparison`

- Сравнение нескольких постов
- Нормализация данных
- Выявление лучших практик

## 3. Реализация управления комментариями (instagram_business_manage_comments)

### 3.1 Backend API endpoints

#### 3.1.1 `/api/instagram/comments/list`

- Получение списка комментариев
- Параметры: mediaId, limit, after
- Возвращает: список комментариев с пагинацией

#### 3.1.2 `/api/instagram/comments/reply`

- Ответ на комментарий
- Параметры: commentId, message
- Возвращает: созданный ответ

#### 3.1.3 `/api/instagram/comments/hide`

- Скрытие комментария
- Параметры: commentId
- Возвращает: статус операции

#### 3.1.4 `/api/instagram/comments/delete`

- Удаление комментария
- Параметры: commentId
- Возвращает: статус операции

#### 3.1.5 `/api/instagram/comments/filter`

- Получение отфильтрованных комментариев
- Параметры: keywords[], status, hasReply
- Возвращает: отфильтрованный список

### 3.2 Frontend компоненты

#### 3.2.1 Компонент `CommentsManager`

##### 3.2.1.1 Список комментариев

- Группировка по постам
- Индикатор непрочитанных
- Быстрые действия

##### 3.2.1.2 Фильтры и поиск

- Поиск по тексту
- Фильтр по статусу (отвеченные/неотвеченные)
- Фильтр по дате

#### 3.2.2 Компонент `CommentThread`

##### 3.2.2.1 Отображение треда

- Исходный комментарий
- Цепочка ответов
- Информация об авторе

##### 3.2.2.2 Интерактивные элементы

- Кнопка ответа
- Меню действий (скрыть, удалить)
- Отметка как прочитанное

#### 3.2.3 Компонент `CommentReplyBox`

##### 3.2.3.1 Редактор ответа

- Текстовое поле с автодополнением
- Шаблоны ответов
- Превью перед отправкой

##### 3.2.3.2 Быстрые ответы

- Сохраненные шаблоны
- Персонализация с @mention
- История ответов

#### 3.2.4 Компонент `CommentModeration`

##### 3.2.4.1 Автомодерация

- Настройка ключевых слов
- Автоматическое скрытие
- Уведомления о подозрительных

##### 3.2.4.2 Массовые действия

- Выбор нескольких комментариев
- Групповые операции
- Экспорт комментариев

### 3.3 Система уведомлений

#### 3.3.1 Real-time уведомления

- WebSocket подключение
- Push уведомления в браузере
- Счетчик непрочитанных

#### 3.3.2 Email уведомления

- Настройка частоты
- Дайджест комментариев
- Приоритетные уведомления

## 4. Реализация Human Agent функционала

### 4.1 Backend API endpoints

#### 4.1.1 `/api/instagram/messages/conversations`

- Получение списка диалогов
- Параметры: limit, status
- Возвращает: список конверсаций

#### 4.1.2 `/api/instagram/messages/thread`

- Получение сообщений в диалоге
- Параметры: threadId, limit
- Возвращает: историю сообщений

#### 4.1.3 `/api/instagram/messages/send`

- Отправка сообщения
- Параметры: threadId, message, agentId
- Возвращает: отправленное сообщение

#### 4.1.4 `/api/instagram/messages/assign`

- Назначение оператора
- Параметры: threadId, agentId
- Возвращает: статус назначения

### 4.2 Frontend компоненты

#### 4.2.1 Компонент `MessagingHub`

##### 4.2.1.1 Список диалогов

- Сортировка по приоритету
- Индикаторы статуса
- Поиск по имени

##### 4.2.1.2 Панель чата

- История сообщений
- Typing индикатор
- Информация о клиенте

#### 4.2.2 Компонент `AgentDashboard`

##### 4.2.2.1 Статистика оператора

- Количество обработанных
- Среднее время ответа
- Рейтинг удовлетворенности

##### 4.2.2.2 Управление очередью

- Автоматическое распределение
- Приоритеты диалогов
- Передача другому оператору

#### 4.2.3 Компонент `MessageComposer`

##### 4.2.3.1 Редактор сообщений

- Rich text форматирование
- Вставка медиа
- Шаблоны сообщений

##### 4.2.3.2 Контекстная информация

- История покупок
- Предыдущие обращения
- Заметки оператора

### 4.3 Система отслеживания

#### 4.3.1 Логирование действий

- Время ответа оператора
- История изменений
- Аудит действий

#### 4.3.2 Метрики производительности

- Dashboard для менеджеров
- Отчеты по операторам
- KPI tracking

## 5. Интеграция с существующей системой

### 5.1 Обновление навигации

#### 5.1.1 Добавление новых разделов в AccountLayout

- Insights & Analytics
- Comments Management
- Direct Messages

#### 5.1.2 Обновление меню

- Иконки для новых разделов
- Badges с количеством непрочитанных
- Быстрый доступ к важным функциям

### 5.2 Обновление прав доступа

#### 5.2.1 Роли пользователей

- Admin - полный доступ
- Analyst - только просмотр insights
- Operator - работа с комментариями и сообщениями

#### 5.2.2 Настройка permissions

- Проверка прав на backend
- Условный рендеринг на frontend
- Аудит доступа

### 5.3 Оптимизация производительности

#### 5.3.1 Кеширование данных

- Redis для insights
- Local storage для draft ответов
- Service Worker для offline

#### 5.3.2 Lazy loading

- Динамическая загрузка компонентов
- Виртуализация списков
- Оптимизация изображений

## 6. Тестирование и документация

### 6.1 Unit тесты

#### 6.1.1 Тесты для API endpoints

- Mock Instagram API responses
- Проверка обработки ошибок
- Валидация параметров

#### 6.1.2 Тесты для компонентов

- Snapshot тесты
- Интеграционные тесты
- E2E тесты критических путей

### 6.2 Документация

#### 6.2.1 API документация

- Swagger/OpenAPI спецификация
- Примеры запросов
- Описание ошибок

#### 6.2.2 Руководство пользователя

- Скриншоты интерфейса
- Пошаговые инструкции
- FAQ секция

## 7. Развертывание и мониторинг

### 7.1 CI/CD pipeline

#### 7.1.1 Автоматические проверки

- Linting и форматирование
- Запуск тестов
- Security scanning

#### 7.1.2 Staged deployment

- Development environment
- Staging с тестовыми данными
- Production с постепенным rollout

### 7.2 Мониторинг

#### 7.2.1 Отслеживание ошибок

- Sentry интеграция
- Custom error boundaries
- Уведомления об критических ошибках

#### 7.2.2 Метрики использования

- Google Analytics
- Custom events tracking
- Performance monitoring

## 8. Порядок реализации

### Фаза 1: Базовая инфраструктура (1-2 недели)

1. Обновление типов данных
2. Создание базовых API endpoints
3. Настройка error handling

### Фаза 2: Insights функционал (2-3 недели)

1. API endpoints для insights
2. Компоненты dashboard
3. Графики и визуализация

### Фаза 3: Управление комментариями (2-3 недели)

1. API для комментариев
2. UI для модерации
3. Система уведомлений

### Фаза 4: Human Agent (3-4 недели)

1. Messaging API
2. Chat интерфейс
3. Система распределения

### Фаза 5: Интеграция и оптимизация (1-2 недели)

1. Объединение всех компонентов
2. Оптимизация производительности
3. Финальное тестирование

### Фаза 6: Документация и развертывание (1 неделя)

1. Написание документации
2. Подготовка deployment
3. Обучение пользователей
